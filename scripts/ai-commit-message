#!/bin/bash

DIFF=$(git diff --cached)

if [ -z "$DIFF" ]; then
    echo "No staged changes found"
    exit 1
fi

echo "Generating AI commit message..."

RECENT_COMMITS=$(git log -n 10 --pretty=format:"%s" 2>/dev/null)

PROMPT="You are a senior software developer.

Here are the 10 most recent commit messages in this repository:

<recent-commits>$RECENT_COMMITS</recent-commits>

Here are the currently staged changes:

<diff>$DIFF</diff>

Generate a commit message for the staged changes.
The commit message should match the projects commit style from the recent commits.

Only respond with the commit message text, nothing else!."

COMMIT_MSG=$(codex -q --json -p OpenAI -m gpt-4.1-mini "$PROMPT" 2>/dev/null | \
  jq -r 'select(.type=="message" and .role=="assistant") | .content[0].text' | \
  head -n 1)

git commit -m "$COMMIT_MSG" --edit
