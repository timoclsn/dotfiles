#!/usr/bin/env bash

STATUS_DIR="$HOME/.local/share/agent-control-center"
SPINNER=('⠋' '⠙' '⠹' '⠸' '⠼' '⠴' '⠦' '⠧' '⠇' '⠏')
spin_idx=0
selected=0

# Colors
DIM='\033[2m'
BOLD='\033[1m'
RESET='\033[0m'
CYAN='\033[36m'
YELLOW='\033[33m'
GREEN='\033[32m'
MAGENTA='\033[35m'
BLUE='\033[34m'

get_agent_label() {
  case "$1" in
    claude) echo "${CYAN}CC${RESET}" ;;
    opencode) echo "${MAGENTA}OC${RESET}" ;;
    codex) echo "${BLUE}CX${RESET}" ;;
    *) echo "${DIM}??${RESET}" ;;
  esac
}

cleanup() {
  tput cnorm 2>/dev/null
  printf "${RESET}"
  exit 0
}

trap cleanup EXIT INT TERM

tput civis 2>/dev/null
clear

while true; do
  output=""

  # Header
  output+="\n"
  output+="${BOLD}${CYAN}  Agent Control Center${RESET}\n"
  output+="${DIM}  ─────────────────────${RESET}\n"
  output+="\n"
  output+="${DIM}  j/k navigate • enter select • x delete • q quit${RESET}\n"
  output+="\n"

  # Read all instances into temp file for sorting
  tmpfile=$(mktemp)

  if [[ -d "$STATUS_DIR" ]]; then
    for file in "$STATUS_DIR"/*.json; do
      [[ -f "$file" ]] || continue

      agent=$(jq -r '.agent // "claude"' "$file")
      status=$(jq -r '.status' "$file")
      path=$(jq -r '.path' "$file")
      session=$(jq -r '.tmux.session' "$file")
      window=$(jq -r '.tmux.window' "$file")
      pane=$(jq -r '.tmux.pane' "$file")
      prompt=$(jq -r '.prompt // ""' "$file")
      timestamp=$(jq -r '.timestamp' "$file")

      parent=$(basename "$(dirname "$path")")
      name=$(basename "$path")
      project="$parent/$name"
      pane_ref="$session:$window.$pane"

      if ! tmux list-panes -t "$session:$window" -F '#{pane_index}' 2>/dev/null | grep -q "^$pane$"; then
        rm "$file"
        continue
      fi

      # Format: project|agent|status|timestamp|window|pane|pane_ref|prompt|session
      echo "${project}|${agent}|${status}|${timestamp}|${window}|${pane}|${pane_ref}|${prompt}|${session}" >> "$tmpfile"
    done
  fi

  # Sort by project (parent/name alphabetically), then window number, then pane number
  sorted=$(sort -t'|' -k1,1 -k5,5n -k6,6n "$tmpfile" 2>/dev/null)
  rm "$tmpfile"

  # Build arrays
  instances=()
  pane_refs=()
  file_paths=()
  current_project=""

  while IFS='|' read -r project agent status timestamp window pane pane_ref prompt session; do
    [[ -z "$project" ]] && continue

    # Project header
    if [[ "$project" != "$current_project" ]]; then
      instances+=("HEADER|$project")
      pane_refs+=("")
      file_paths+=("")
      current_project="$project"
    fi

    # Agent label
    agent_label=$(get_agent_label "$agent")

    # Status indicator
    if [[ "$status" == "working" ]]; then
      indicator="${YELLOW}${SPINNER[$spin_idx]}${RESET}"
    else
      indicator="${GREEN}○${RESET}"
    fi

    if [[ -n "$prompt" ]]; then
      display="$indicator [$agent_label] ${DIM}$prompt${RESET} ${DIM}($window.$pane)${RESET}"
    else
      display="$indicator [$agent_label] ${DIM}($window.$pane)${RESET}"
    fi

    instances+=("ITEM|$display")
    pane_refs+=("$pane_ref")
    file_paths+=("$STATUS_DIR/$session-$window-$pane.json")
  done <<< "$sorted"

  # Count selectable items
  selectable=()
  for i in "${!instances[@]}"; do
    if [[ "${instances[$i]}" == ITEM* ]]; then
      selectable+=("$i")
    fi
  done
  count=${#selectable[@]}

  [[ $count -gt 0 && $selected -ge $count ]] && selected=$((count - 1))
  [[ $selected -lt 0 ]] && selected=0

  # Render
  sel_idx=0
  for i in "${!instances[@]}"; do
    type="${instances[$i]%%|*}"
    content="${instances[$i]#*|}"

    if [[ "$type" == "HEADER" ]]; then
      output+="${BOLD}  $content${RESET}\n"
    elif [[ "$type" == "ITEM" ]]; then
      if [[ $count -gt 0 && $sel_idx -eq $selected ]]; then
        output+="  ${CYAN}▸${RESET} $content\n"
      else
        output+="    $content\n"
      fi
      ((sel_idx++))
    fi
  done

  if [[ $count -eq 0 ]]; then
    output+="${DIM}  No active instances${RESET}\n"
  fi

  tput cup 0 0 2>/dev/null
  printf "${output}"
  tput ed 2>/dev/null

  spin_idx=$(( (spin_idx + 1) % ${#SPINNER[@]} ))

  if read -t 0.1 -n 1 -s -r key; then
    case "$key" in
      j|B) ((selected++)) ;;
      k|A) ((selected--)) ;;
      x)
        if [[ $count -gt 0 ]]; then
          ref_idx="${selectable[$selected]}"
          rm -f "${file_paths[$ref_idx]}" 2>/dev/null
        fi
        ;;
      q) break ;;
      "")
        if [[ $count -gt 0 ]]; then
          ref_idx="${selectable[$selected]}"
          tmux switch-client -t "${pane_refs[$ref_idx]}"
          break
        fi
        ;;
    esac
  fi
done
